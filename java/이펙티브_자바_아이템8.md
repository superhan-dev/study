# 작성일

- 2025-11-10

# finalizer

`finalize()`는 java.lang.Object 클래스에 정의되어있는 메소드로 GC로 부터 객체를 실제 회수하기 직전에 한 번 호출될 수도 있는 콜백이다. 하지만 실행 시점에 실행 여부가 보장되지 않고 예외도 무시되며 객체가 부활할 수도 있어 성능 저하와 데드락을 발생시키기도 하기 때문에 사실상 사용을 금지하는 메소드이다.

## 동작 개요

1. 어떤 객체가 일반 참조에서 도달 불가한 상태가 되면 JVM이 그 객체를 finalization queue에 넣고 전용 finalizer 스레드가 finalize()를 호출 할 수 있다.
2. 호출 뒤에도 참조가 다시 잡히지 않으면(부활하지 않으면) GC 대상이 된다.
   - 코드 단에서 메모리를 소멸시키는 C++ 파괴자와는 다른 개념이다.

# cleaner

Cleaner는 Java 9 부터 사용되기 시작한 정리 메커니즘이다. finalize()의 대체재 이지만 정식 소멸자는 아니다. 역시나 실행 시점이 보장되지 않으므로 자원이 해제되는 것은 아니다.

# 리소스 정리가 필요하다면 AutoCloseable을 사용하라.

## AutoCloseable

정리가 필요한 자원을 `try-with-resources`로 자동으로 닫게 해주는 인터페이스 이다.

### 목적

파일, 소켓, DBCP, Lock Buffer 등 수명 관리가 필요한 자원을 블록이 끝날때 자동으로 `close()`를 호출하도록 만들기 위해 사용한다.

### 선언 방법

```java
public interface AutoCloseable { void close() throws Exception; }

class MyConn implements AutoCloseable {
  @Override
  public void close() {
    // 정리 로직 (idempotent 하게)
  }
}
```

### 사용 예시

AutoCloseable을 구현해서 close메소드를 구현해주고
TWR를 구현해서 사용하는 방법이다.

다음과 같이 클래스를 구현한 뒤 조기 해제 하거나 finally로 닫아서 TWR를 구현할 수 있다.

```java
public final class NativeBuffer implements AutoCloseable {
  private static final Cleaner CLEANER = Cleaner.create();

  // 정리 대상만 담는 불변 상태 객체(바깥 this 캡처 금지)
  private static final class State implements Runnable {
    private long addr;  // 예: native 메모리 포인터
    State(long addr) { this.addr = addr; }

    @Override public void run() {
        if (addr != 0) {
            freeNative(addr);
            addr = 0;
        }
    }
  }

  private final State state;
  private final Cleaner.Cleanable cleanable;
  private volatile boolean closed;

  public NativeBuffer(int size) {
    long addr = mallocNative(size);
    this.state = new State(addr);
    this.cleanable = CLEANER.register(this, state); // 객체가 unreachable 되면 실행
  }

  @Override public void close() {
    if (!closed) {
      closed = true;
      cleanable.clean(); // 명시적 정리(동기) — 한 번만, idempotent
    }
  }

  private static native long mallocNative(int size);
  private static native void freeNative(long addr);
}

public class Main {
    public static void main(String[] args){
        // Java 9+ (이미 만든 변수를 TWR에 올리기)
        // 이와 같이 구현하면
        NativeBuffer buf = new NativeBuffer(2048);
        try (buf) {
        // 사용
        } // 자동 close

    }
}

```

### try 문 안에서 조기 close

```java

// TWR로 구현
try (NativeBuffer buf = new NativeBuffer(4096)) {
    // 사용
    buf.close();  // 여기서 바로 해제
    // 이후 코드는 buf를 더 이상 사용하지 않아야 함
}


```

### Finally 에서 close

```java

NativeBuffer buf = null;
try {
  buf = new NativeBuffer(1024);
  // 사용
} finally {
  if (buf != null) buf.close();
}

```
