# 작성일

# 태그

- 면접 질문

# 롤링업과 블루그린 배포의 차이점

## 1. 롤링업 배포

롤링업 배포는 버전을 다르게 하나씩 새로운 버전을 띄워가며 교체하며 배포하는 방식이다.

### v1버전 -> v2버전 업데이트 롤링업 배포 순서

pod개수는 2개를 맞춘다고 가정했을 때 다음과 같이 배포가 진행된다.

1. v1 pod가 두개 있는 경우 v2 인스턴스 1개 생성
   - 이때 pods수는 총 3개가 됨
   - 완료가 되어 pod가 정상 상태라면 v1 pod를 한개 제거
   - pods는 다시 2개로 유지
     - 하지만 이때 두개의 Pod간에 버전이 달라지는 이슈 발생
     - 트래픽은 각기 다른 두개의 버전으로 들어오므로 DB 변경과 같은 환경이 달라지면 장애 발생
2. v2버전을 하나더 생성
   - 이때 pods는 총 3개가 됨
   - v2 pod가 완료되면 나머지 v1 pod 내림
3. 업데이트가 완료되면 pod가 2개로 유지

### 단점

- 롤백도 롤링 하기 때문에 느리다.
- 두개의 버전이 겹쳐서 DB를 구버전을 유지해야 장애가 발생하지 않음.

### 꼬리질문

- 롤링 업데이트는 위와 같이 두개의 버전이 달라지는 이슈가 존재하고 이때 트레픽이 들어오면 장애가 발생할 확률이 있는데 이를 어떻게 대응할 것인가?
  - 컬럼은 변경하는게 아니라 한동안 공존시키고 천천히 바꿔야 한다.

#### 변경 경우의 수

1. Rename(컬럼명 변경)
   - ALTER TABLE ... RENAME COLUMN old -> new는 금지
     - 구버전 pod가 읽게되면 바로 에러가 발생한다.

**대응 방법**

- new_col 추가 (Expend)
  - ALTER TABLE ADD COLUMN new 로 무조건 expend 한다.
- 코드 배포: 읽기/쓰기 호환
  - 읽기: COALESCE(new_col, old_col) 같은 fallback
  - 쓰기: 한동안 dual write (둘 다 채우기)
- 백필: 기존 row의 new_col을 old_col로 채움
- 전환 완료 후 구버전 없어지면 old_col 제거 (Contract)
  - 이때 데이터 마이그레이션 필요

> 실무 팁: dual write는 앱에서 해도 되고, DB 트리거로 해도 되는데 트리거는 편하지만 “숨은 로직”이 되어 운영 난이도가 올라갈 수 있다. (앱에서 로직으로 드러나는 것이 좋다.)

2. 타입 변경(예: INT → BIGINT, VARCHAR 길이 변경)

**대응 방법**

- 좁히는 변경이 위험하고 넓히는 변경은 비교적 안전하다.
  - INT -> BIGINT, VARCHAR(50) -> VARCHAR(255)와 같이 넓히는 것은 괜찮다.
  - BIGINT -> INT, VARCHAR 줄이는 것은 위험하다.
- 새 컬럼 new_col을 목표타입으로 추가
- dual write + back fill
  - 두개의 컬럼에 모두 쓰기를 하고 추가 마이그레이션 하라는 의미
- 새 코드는 new_col만 쓰도록 전환
- old 컬럼 제거

3. NOT NULL 추가 / 기본값 변경

**대응 방법**

- 바로 NOT NULL을 허용하지 말고 back fill로 값 채우기
- 앱전환 완료 후 마지막에 NOT NULL + 제약조건 적용

4. 컬럼 삭제(제거)

**대응 방법**

- 삭제는 항상 맨 마지막에 한다.
- 보통은 사용안함 기간을 두고 제거한다.

> “롤링 배포는 무중단이지만, 버전이 섞여서 동작하므로 스키마 변경엔 주의가 필요합니다.”

## 2. 블루그린 배포

블루그린 배포는 한대의 인스턴스와 환경을 띄워놓고 한번에 트래픽을 바꿔 교체하는 방식이다.

**장점**

- 즉시 롤백 가능
- 버전 혼재 없음
- DB 변경, 대규모 수정에 안정적

**단점**

- 리소스 2배 필요
- 인프라 구성 복잡
- 트래픽 전환 순간 리스크

**언제 쓰나?**

- DB 스키마 변경
- 결제 / 인증 / 핵심 비즈니스
- 릴리즈 안정성이 최우선일 때

> “블루그린은 비용은 들지만, 안정성과 롤백 측면에서는 가장 강력한 전략입니다.”

### 2.1. 블루 그린 배포 고려사항

1. “환경 2세트” 자체가 관리 포인트를 두 배로 만듦

- Deployment/ReplicaSet을 2개(blue, green)
- 설정(ConfigMap/Secret), 서비스 디스커버리, 오토스케일링(HPA)도 2세트로 맞춰야 함
- 리소스/쿼터/노드 용량 계산도 두 배

2. 트래픽 스위칭 계층이 추가됨 (여기가 제일 까다로움)

- 블루→그린 전환은 결국 라우팅을 바꾸는 작업이라, Service selector 교체
- Ingress/ALB 타겟 그룹 전환
- Service Mesh(Istio/Linkerd) 가중치 전환 같은 “스위치 장치”가 필요하다.

  이 스위치가 잘못되면

  - 일부 트래픽만 옛버전으로 새버전으로 섞여 들어가거나
  - 전환 순간 502/503 스파이크가 나거나
  - 세션/쿠키/웹소켓이 끊기거나

  하는 문제가 생김.

3. “전환 전 검증”을 위한 별도 동선이 필요함
   그린을 띄워두고 실제 트래픽 붙이기 전에 검증하려면:

   - 내부 도메인/프리뷰 URL
   - 헤더 기반 라우팅(특정 사용자만 그린으로)
   - smoke test / e2e test
   - 헬스체크 기준(ready/liveness) 정교화
     이런 “검증 파이프”가 필요해서 운영 설계가 복잡해진다.

4. 상태(State) 있는 것들 때문에 더 어려워짐

블루그린은 앱은 깔끔해도, 같이 붙어있는 것들이 문제가 될 수 있다.

- DB 마이그레이션 타이밍
- 캐시(Redis) 키 스키마 변경
- 메시지 컨슈머(카프카 컨슈머 그룹) – 블루/그린이 동시에 consume하면 중복 처리 위험
- 배치/크론잡이 두 세트 돌면 “중복 실행” 위험

그래서 보통 컨슈머/배치/크론은 전환 순간에만 한쪽만 활성화 또는 leader election/락 같은 추가 설계가 들어감.

5. 롤백은 쉽지만 “정리/가비지”가 남는다

블루그린은 롤백은 “스위치 되돌리기”라 빠른 대신,

- 그린/블루 중 사용 안 하는 쪽 리소스 정리
- 로그/모니터링이 두 버전으로 쪼개짐
- 운영 툴링(대시보드/알람/런북)이 두 배
  이런 운영 복잡도가 생김.

## 3. 비교표

| 항목        | 롤링업 | 블루그린 |
| ----------- | ------ | -------- |
| 무중단      | O      | O        |
| 버전 혼재   | O      | X        |
| 롤백 속도   | 느림   | 즉시     |
| 리소스      | 적음   | 2배      |
| DB 변경     | 위험   | 안전     |
| 복잡도 낮음 | 높음   |
