# 1. 사용 파일 전체 맵

## 시간의 중심
- `orders.csv`

## 관계 연결
- `order_items.csv` (Seller 연결)
- `customers.csv` (지역 정보)
- `sellers.csv` (판매자 지역 정보)
- `products.csv` (카테고리 정보)
- `order_reviews.csv` (만족도 정보)

---

# 2. Fact Table 정의: fact_order_delivery

핵심 Fact 테이블로서 주문 배송 관련 데이터를 집계합니다.

## orders.csv 활용

| 컬럼 | 용도 |
| :--- | :--- |
| `order_id` | PK, 모든 테이블의 조인 키 |
| `order_purchase_timestamp` | 주문 시작 시점 |
| `order_approved_at` | 결제 승인 시점 |
| `order_delivered_carrier_date` | 판매자 → 택배사 전달 시점 |
| `order_delivered_customer_date` | 고객 도착 시점 |
| `order_estimated_delivery_date` | SLA 기준일 |

> Latency 계산의 기준이 됩니다.

## order_items.csv 활용

| 컬럼 | 용도 |
| :--- | :--- |
| `order_id` | orders 조인 |
| `seller_id` | 판매자 식별 |
| `product_id` | 상품 연결 |
| `shipping_limit_date` | (보조) 출고 제한일 |

> 주문 1건에 여러 Seller가 포함될 수 있으므로 `order_id` + `seller_id` 단위로 관리합니다.

## customers.csv 활용

| 컬럼 | 용도 |
| :--- | :--- |
| `customer_id` | 주문자 식별 |
| `customer_city` | 지역 분석 |
| `customer_state` | 지역 분석 |

## sellers.csv 활용

| 컬럼 | 용도 |
| :--- | :--- |
| `seller_id` | 판매자 식별 |
| `seller_city` | 판매자 도시 |
| `seller_state` | 판매자 주 |

## products.csv 활용

| 컬럼 | 용도 |
| :--- | :--- |
| `product_id` | 상품 식별 |
| `product_category_name` | 카테고리 분석 |

---

# 3. 분석 데이터 구성

## fact_order_delivery 최종 스키마

```text
fact_order_delivery
-------------------
order_id                -- orders
seller_id               -- order_items
product_category        -- products

customer_state          -- customers
customer_city

seller_state            -- sellers

purchase_ts             -- orders.order_purchase_timestamp
approved_ts             -- orders.order_approved_at
carrier_ts              -- orders.order_delivered_carrier_date
delivered_ts            -- orders.order_delivered_customer_date
estimated_ts            -- orders.order_estimated_delivery_date
```

## Latency 파생 컬럼 (orders.csv 기반)

```text
payment_latency_hours = approved_ts - purchase_ts
seller_handling_latency_hours = carrier_ts - approved_ts
carrier_delivery_latency_hours = delivered_ts - carrier_ts
total_delivery_latency_hours = delivered_ts - purchase_ts
```

## 지연 여부 판단

```text
is_delayed = delivered_ts > estimated_ts
```

---

# 4. 지역별 배송 지연 분석: delivery_latency_by_region

| 출처 | 컬럼 |
| :--- | :--- |
| `fact_order_delivery` | `customer_state` |
| `fact_order_delivery` | `total_delivery_latency` |
| `fact_order_delivery` | `is_delayed` |

### 집계 쿼리 예시

```sql
SELECT
    customer_state,
    COUNT(*) AS order_count,
    AVG(total_delivery_latency_hours) AS avg_latency,
    PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY total_delivery_latency_hours) AS p90_latency,
    AVG(CASE WHEN is_delayed THEN 1 ELSE 0 END) AS delay_rate
FROM fact_order_delivery
GROUP BY customer_state;
```

---

# 5. 판매자별 배송 지연 분석: delivery_latency_by_seller

| 출처 | 컬럼 |
| :--- | :--- |
| `fact_order_delivery` | `seller_id` |
| `fact_order_delivery` | `seller_handling_latency` |
| `fact_order_delivery` | `carrier_delivery_latency` |
| `fact_order_delivery` | `is_delayed` |

### 지표 의미
- `seller_handling_latency` 높음 → 출고 병목
- `carrier_delivery_latency` 높음 → 물류 병목

---

# 6. 판매자 성과 분석: seller_performance_features

`order_reviews.csv` 활용

| 컬럼 | 용도 |
| :--- | :--- |
| `order_id` | orders 조인 |
| `review_score` | 만족도 |
| `review_creation_date` | (선택) 리뷰 작성일 |

### SQL 예시

```sql
SELECT
    f.seller_id,
    COUNT(*) AS total_orders,
    AVG(total_delivery_latency_hours),
    AVG(seller_handling_latency_hours),
    AVG(CASE WHEN is_delayed THEN 1 ELSE 0 END) AS delay_rate,
    AVG(r.review_score) AS avg_review
FROM fact_order_delivery f
LEFT JOIN order_reviews r ON f.order_id = r.order_id
GROUP BY f.seller_id;
```

---

# 7. 판매자 점수 테이블: seller_score

| Feature | 출처 |
| :--- | :--- |
| `on_time_rate` | `1 - delay_rate` |
| `avg_delivery` | `seller_performance_features` |
| `avg_review` | `seller_performance_features` |

### 점수 계산 로직

필수적으로 정규화(Min-Max 또는 Z-Score)를 수행합니다.

```text
score = 0.4 * on_time_rate
      - 0.3 * (1 / avg_delivery)
      - 0.3 * avg_review
```

---

# 8. ETA 예측 통계: delivery_eta_stats

### Key 조합

| 컬럼 | 출처 |
| :--- | :--- |
| `seller_id` | `order_items` |
| `customer_state` | `customers` |
| `product_category` | `products` |

### 계산 대상

| 값 | 출처 |
| :--- | :--- |
| `total_delivery_latency` | `fact_order_delivery` |

### SQL 예시

```sql
SELECT
    seller_id,
    customer_state,
    product_category,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY total_delivery_latency_hours) AS p50_hours,
    PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY total_delivery_latency_hours) AS p90_hours,
    COUNT(*) AS sample_count
FROM fact_order_delivery
GROUP BY seller_id, customer_state, product_category;
```

---

# 9. 일별 배송 이상 탐지: delivery_anomaly_daily

## 사용 컬럼

| 출처 | 컬럼 |
| :--- | :--- |
| `fact_order_delivery` | `delivered_ts` |
| `fact_order_delivery` | `total_delivery_latency` |
| `fact_order_delivery` | `seller_id` / `customer_state` |

## 일 단위 집계

```sql
SELECT
    DATE(delivered_ts),
    AVG(total_delivery_latency)
...
```

> 과거 평균 대비 급증 시 Anomaly로 판단합니다.