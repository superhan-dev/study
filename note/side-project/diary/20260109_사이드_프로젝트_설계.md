# [Project] Data-Driven OMS: 리플레이 기반 물류 최적화 시스템 설계

## 1. 프로젝트 목표와 문제 정의

본 프로젝트는 **Olist OMS(Order Management System)** 관점에서 과거 주문·배송 데이터를 분석하여 **고객 경험(CX)을 저해하는 병목과 비효율을 식별하고**,
이를 바탕으로 **운영 성능을 정량적으로 개선할 수 있는 인사이트와 기능 제안**을 도출하는 것을 목표로 한다.

데이터 리플레이를 통해 데이터 드리븐에 적합한 시스템 아키텍처를 구축한다.

- 적절한 시점에 알림 또는 관리 페이지에 notice를 보내줄 수 있는 기능
- 재고가 떨어지면 자동으로 재고를 주문할 수 있는 기능
- 배송 지연을 예측하고 알림을 통해 사전 대응을 할 수 있는 서비스 등

기존 시스템이 있다고 가정하고 개선 기능들을 개발하여 전체적인 시스템 고도화를 도모한다.

OMS는 주문 이후의 모든 흐름(결제 승인, 셀러 처리, 배송 인계, 고객 도착)을 책임지는 시스템이다.
데이터 기반 의사결정으로 **배송 속도·예측 신뢰도·셀러 품질**을 개선하면 곧바로 고객 경험으로 연결된다.

> 가정: Olist OMS 팀에 소속된 엔지니어 관점으로, 기존 운영 로그(과거 데이터)를 활용해 시스템 품질을 개선한다.

---

## 2. 데이터셋 개요

이 데이터셋은 Olist Store가 제공한 공개 데이터로, 약 **100,000건의 주문(Order)** 이 포함되어 있으며, 주문 생성부터 배송 완료 및 리뷰까지의 전 과정을 추적할 수 있다.

또한 재고 관리 데이터를 임의로 구축하여 WMS의 개념까지 함께 다루므로써 OMS 서비스의 퀄리티 향상을 도모한다.

### 2.1. 데이터 파일 구성

| 파일 이름                                 | 설명                                |
| ----------------------------------------- | ----------------------------------- |
| **olist_orders_dataset.csv**              | 주문 단위의 상태 및 핵심 타임스탬프 |
| **olist_order_payments_dataset.csv**      | 주문별 결제 정보                    |
| **olist_order_items_dataset.csv**         | 주문 내 상품 및 판매자 정보         |
| **olist_customers_dataset.csv**           | 고객 정보 및 위치                   |
| **olist_sellers_dataset.csv**             | 판매자 정보 및 위치                 |
| **olist_order_reviews_dataset.csv**       | 고객 리뷰 및 만족도                 |
| **olist_products_dataset.csv**            | 상품 정보                           |
| **product_category_name_translation.csv** | 상품 카테고리 번역                  |
| **olist_geolocation_dataset.csv**         | 우편번호 기반 위치 데이터           |

이 중 **OMS 관점의 핵심 테이블은 orders / order_items / payments / reviews** 이다.

---

## 3. 주문·배송 플로우 정의 (OMS 관점)

다음은 실제 데이터 컬럼을 근거로 재구성한 **표준 주문 라이프사이클**이다.

```
[ 주문 생성 (Order Created) ]
    ↓ order_purchase_timestamp

[ 결제 등록 (Payment Registered) ]
    ↳ payment_type
    ↳ payment_value

[ 결제 승인 (Payment Approved) ]
    ↓ order_approved_at

[ 셀러 처리 / 배송 준비 (Seller Fulfillment) ]
    ↓ order_delivered_carrier_date

[ 배송 완료 / 고객 수령 (Delivered to Customer) ]
    ↓ order_delivered_customer_date

[ 고객 리뷰 (Post-delivery Feedback) ]
    ↳ review_score
```

### 단계별 해석

- **주문 생성**: 고객이 결제를 시도한 최초 시점
- **결제 등록**: 실제 결제 수단·금액이 기록됨 (복수 결제 가능)
- **결제 승인**: PG 또는 금융기관 승인 완료 시점 → OMS 처리 시작 기준점
- **배송 준비**: 셀러가 상품을 포장하여 택배사에 인계한 시점 (OMS 핵심 성능 지표)
  - 셀러가 상품을 미리 택배사에 인계하여 재고를 미리 채워넣을 수 있는 시스템을 새롭게 구축
- **배송 완료**: 고객에게 실제 도착한 시점
- **리뷰**: 배송·상품·서비스 전반에 대한 결과 지표

---

## 4. 핵심 문제 영역(Pain Points) 가설

데이터를 통해 검증하고자 하는 OMS 관점의 문제는 다음과 같다.

1. 신뢰할 수 있는 배송시간 제공이 가능하도록 하려면 어떻게 해야하는가?

- 1.1. 셀러별 배송 준비 시간 편차를 파악하고 배송 시간 편차를 줄여 균일한 품질의 배송 퀄리티를 낼 수 있도록 실태를 파악한다.
- 1.2. 배송 지연이 발생하는 단계를 파악한다. 배송 지연구간이 셀러쪽인지 운송회사쪽인지 데이터 기반으로 식별한다.

3. 상위랭커 셀러/루트 파악

- 3.1. 빠른 배송 이력이 있는 셀러/루트와 루트 랭킹을 관리하여 상위랭커들이 제품 등록시 상위에 노출시켜 공정한 경쟁을 유도할 때 사용한다.
- 3.2. 주문이 들어오면 빠른 루트로 추천 서비스를 사내 서비스로 구축하다.

4. 고객 만족도는 배송 속도·예측 정확도와 강한 상관관계가 있는지 식별한다.

---

## 5. 인사이트 기반 기능 제안

### 5.1 배송 경로 추천 (Route Recommendation)

**아이디어**

- 상품별·셀러별·지역별 배송 이력을 분석하여
- "어디서 → 어디로 → 얼마나 빨리" 배송되었는지를 루트 단위로 학습

**구현 개념**

- 배송 루트 = (seller_zip → customer_zip, product_category)
- 과거 배송 리드타임 평균/분산 계산
- 빠르고 안정적인 루트에 가중치 부여
- 핵심 데이터 컬럼 리스트

  - 위치 정보 (Where: 노드 및 경로 식별)

  - 가장 정밀한 분석을 위해 customer_zip_code_prefix를 핵심 키로 사용

    - [sellers 테이블]:

      - seller_zip_code_prefix: 판매자의 위치 (출발점)
      - seller_city / seller_state: 지역별 그룹화 분석용

    - [customers 테이블]:

      - customer_zip_code_prefix: 고객의 위치 (도착점)
      - customer_city / customer_state: 지역별 그룹화 분석용

    - [geolocation 테이블 (위치 보정)]:

      - geolocation_lat / geolocation_lng: 우편번호별 위경도 좌표. **두 지점 사이의 실제 물리적 거리(Haversine Distance)**를 계산하여 "거리 대비 속도"를 산출할 때 필수적입니다.

  - 시간 정보 (When: 리드타임 및 성능 측정)
    경로의 품질을 결정하는 라벨링 데이터
    - [orders 테이블]:
      - order_purchase_timestamp: 주문 발생 시점
      - order_delivered_carrier_date: 판매자 → 물류사 인계 시점 (First-mile 성능)
      - order_delivered_customer_date: 물류사 → 고객 완료 시점 (Last-mile 성능)
      - order_estimated_delivery_date: 플랫폼이 약속한 시간 (이후 지연 여부 판단 기준)
  - 상품 및 제약 조건 (Context: 추천 가중치)

    - [products 테이블]:
      - product_weight_g: 무게 (무거울수록 특정 물류 경로에서 지연 발생 가능성 높음)
      - product_length_cm, product_height_cm, product_width_cm: 부피 정보

    **활용**

- 신규 주문 발생 시 OMS가 추천 배송 루트/셀러를 우선 선택
- 데이터 리플레이 기반 시뮬레이션으로 성능 검증

---

### 5.2 셀러 랭킹 시스템 (Seller Rank)

OMS 내부에서 **정량화된 셀러 품질 지표**를 유지한다.

#### 핵심 지표 구성

1. **Fulfillment Speed Score**

   - (order_delivered_carrier_date - order_approved_at)
   - 결제 승인 이후 셀러 처리 속도

2. **Delivery Reliability Score**

   - estimated_delivery_date 대비 실제 도착 오차

3. **Customer Satisfaction Score**

   - 평균 review_score

> 종합 셀러 점수 = w1*속도 + w2*신뢰 + w3\*만족도

#### 활용 시나리오

- 검색 결과 정렬 (배송 빠른 셀러 우선)
- "이달의 셀러" 선정
- SLA 관리 및 페널티 정책 근거

---

### 5.3 배송 지연 사전 개입

배송 지연을 **사후 분석이 아닌, 사전 개입 영역**으로 전환한다.

- 발송 전 지연:

  - 승인 → 배송사 인계 구간이 임계값 초과 시 알림
  - 셀러 또는 운영자 개입

- 배송 중 지연:

  - carrier_date → customer_date 분포 기반 이상치 탐지

---

## 6. 단계별 데이터 근거 정리

| 단계      | 테이블 / 컬럼                        | OMS 관점 의미  |
| --------- | ------------------------------------ | -------------- |
| 주문 생성 | orders.order_purchase_timestamp      | 주문 유입 시점 |
| 결제      | payments.payment_type, value         | 결제 패턴      |
| 승인      | orders.order_approved_at             | OMS 처리 시작  |
| 배송 준비 | orders.order_delivered_carrier_date  | 셀러 성능 핵심 |
| 배송 완료 | orders.order_delivered_customer_date | 고객 체감 배송 |
| 리뷰      | reviews.review_score                 | 결과 품질 지표 |

---

## 7. 기대 효과

- 배송 리드타임 평균 및 분산 감소
- 고객 리뷰 점수 개선
- 셀러 품질의 가시화 및 관리 가능
- OMS 의사결정의 자동화·지능화

---

# 8. 아키텍처 상세화

## 8.1. 실시간 리플레이를 위한 "이벤트 드리븐 아키텍처" 상세화

- Time-Stepper (타임 시뮬레이터):
  - airflow를 사용하여 과거 시간을 마치 현재 시간인것처럼 스트리밍한다.
- State Store (상태 저장소):
  - 리플레이되는 주문들의 현재 상태(결제 완료, 출고 대기 등)를 메모리(Redis 등)에 유지하며 실시간으로 지표를 계산한다.
  - Kafka Streams을 활용한 window aggregation을 통해 지역별/셀러별 실시간 지연율을 산출한다.

## 8.2. 지능형 재고 관리 (Inventory Automation)

재고관리를 추가해서 (olist_inventory_dataset) 임의 값들을 넣어두고 가상 재고관리를 할 수 있다.

## 8.2.1. 재고 관리 테이블

재고 관리 개념을 추가하여 OMS와 WMS 개념을 더하는 설계를 한다.
olist재고는 seller의 창고에서 보관하고있다가 olist의 Warehouse에 전달하여 고객에게 배송하는 시스템이다.
때문에 WMS는 재고 부족으로 인한 출고 지연을 예방하기 위해 재고가 부족할 시 셀러들에게 알림 서비스를 제공하여 재고를 미리 보충하도록 안내한다.

```sql
CREATE TABLE IF NOT EXISTS olist_inventory_dataset (
    product_id VARCHAR(32),
    seller_id VARCHAR(32),
    current_stock INTEGER DEFAULT 0,      -- 현재 실재고 수량
    reserved_stock INTEGER DEFAULT 0,     -- 주문은 들어왔으나 아직 출고(carrier_date) 전인 수량
    safety_stock INTEGER DEFAULT 10,      -- 안전 재고 (이 아래로 떨어지면 자동 주문 트리거)
    reorder_point INTEGER,                -- 재발주 지점 (리드타임 고려하여 계산된 수치)
    lead_time_days INTEGER,               -- 재입고 소요 기간 (판매처로부터 물건을 떼오는 시간)
    last_updated_at TIMESTAMP,

    PRIMARY KEY (product_id, seller_id),
    FOREIGN KEY (product_id) REFERENCES olist_products_dataset(product_id),
    FOREIGN KEY (seller_id) REFERENCES olist_sellers_dataset(seller_id)
);
```

## 8.2.2. 이벤트 기반 재고 테이블

상태기반 테이블은 재고가 언제부터 왜 이런 상태였는지

```sql
-- =========================
-- Inventory Event Dataset (Source of Truth)
-- =========================
CREATE TABLE olist_inventory_events (
    inventory_event_id UUID PRIMARY KEY,
    product_id VARCHAR(32),
    seller_id VARCHAR(32),
    order_id VARCHAR(32),
    event_type VARCHAR(50), -- RECEIVED, RESERVED, RELEASED, SHIPPED, RETURNED, DAMAGED
    quantity INTEGER,
    event_timestamp TIMESTAMP,
    source VARCHAR(50) -- order, return, manual, replay
);
```

## 8.3. 왜 이 컬럼들이 필요한가요? (OMS 기능 중심)

### 8.3.1. current_stock vs reserved_stock

이유: 결제가 승인(order_approved_at)되는 순간 재고를 바로 깎으면 안 된다.

로직: 결제 승인 시 reserved_stock을 +1 하고, 택배사에 인계(order_delivered_carrier_date)되는 순간 current_stock과 reserved_stock을 동시에 -1 해야 정확한 가용 재고(Available Stock) 파악이 가능하다.

가용 재고 공식: current_stock - reserved_stock

### 8.3.2. safety_stock (안전 재고)

기능: "재고가 떨어지면 자동 주문" 기능을 위한 기준점.

OMS 진화: 과거 데이터를 리플레이하며 **"이 상품은 평균적으로 하루에 3개가 팔린다"**는 것을 알 수 있다. 만약 재입고에 3일이 걸린다면 최소 9개는 항상 있어야 한다.

### 8.3.3. reorder_point (재발주 시점)

기능: 단순히 재고가 0일 때 주문하면 늦습니다.

공식: (일일 평균 판매량 \* 리드타임) + 안전 재고

활용: 리플레이 시스템에서 실시간으로 재고를 차감하다가 이 수치에 도달하면 Auto-Order API를 호출하는 시뮬레이션을 구현할 수 있다.

# 9. 아키택처 데이터 흐름

1. Source: PostgreSQL (Olist 원본 데이터)
2. Producer (Simulated Now): 시간 간격에 맞춰 Kafka로 전송
3. Processing: Kafka Streams (실시간 지표 & 윈도우 집계)
4. State Store: Redis (실시간 가용 재고 및 셀러별 스코어 캐싱)
5. Sink/Action: \* Alert Service: 지연 예측 시 고객/셀러 알림 발송
6. Inventory Worker: reorder_point 도달 시 입고 이벤트 자동 생성
7. Dashboard: Grafana (실시간 물류 병목 현황 시각화)

> 본 프로젝트는 단순 데이터 분석을 넘어, **OMS가 어떻게 더 똑똑해질 수 있는가**에 대한 시스템적 개선 제안이다.

# 10. 정리

현재 존재하는 데이터들을 분석하고 위와 같이 프로젝트 진행 방향을 잡고 소유한 데이터로 프로젝트 설계를 진행했다.

다음으로 실제 SQL을 통해 데이터 분석을 진행하면서 아이디어들을 실체화 할 수 있는 요소들과 실제 과정에서 있었을 것으로 추정되는 페인포인트를 예상해보고 해결 방안에 대해 접근해보자.

# 11. 데이터 분석 결과

데이터 분석결과 해당 데이터들은 매우 느린 시간에 배송이 이루어지고 있었으며 셀러가 결제가 이루어진 후에 액션을 취하는 부분이 배송을 느리게 하는 요인 중 하나로 꼽혔다. 때문에 재고를 관리할 수 있는 WMS를 도입하면 배송 품질을 개선할 수 있을 것으로 보여졌다.

가장 많은 주문이 발생하는 **SP(상파울루)**를 기준으로 데이터를 해석해 보면, 가상 재고 관리 시스템이 개입할 여지가 얼마나 큰지 알 수 있습니다.

1. 쿼리 결과 해석 (As-Is 진단)

- Prep Time의 비중 (약 50% 이상):
  - 대부분의 주(State)에서 출고 지연 주문들의 prep_time_ratio가 **53~54%**에 육박합니다.
  - 즉, 고객이 물건을 받기까지 걸리는 전체 시간 중 절반 이상을 셀러가 물건을 포장하고 인계하는 데 소비하고 있다는 뜻입니다.
  - 결론: 운송(Carrier) 단계를 건드리는 것보다, WMS를 통해 출고(Prep) 단계를 단축하는 것이 배송 속도 개선에 훨씬 효율적입니다.
- 상파울루(SP)의 기회 요인:
  - 가장 많은 지연 주문(9,461건)이 발생하며, 평균 231시간(약 9.6일)이나 소요됩니다.
  - 물류 인프라가 가장 좋은 SP에서도 이런 지연이 발생한다는 것은 교통 체증보다는 '재고 부족'이나 '운영 미숙'일 확률이 매우 높습니다.

2. 시뮬레이션: 가상 재고 시스템(To-Be) 적용 효과

우리의 가상 재고 관리 시스템(안전 재고 유지 + 자동 발주)이 적용되었다면, 위 지연 주문들의 출고 시간은 **당일 또는 익일(24시간 이내)**로 단축되었을 것입니다.

지표,As-Is (현재),To-Be (가상 시스템 적용),개선 효과
SP 지역 출고 시간,231.7시간,24시간 (가정),약 207시간 단축
전체 배송 비중,54.9%,약 10% 미만,CX(고객 경험) 혁신

3. OMS 대시보드 및 API 설계 (Action Item)이 데이터를 바탕으로 관리자가 보게 될 **"지능형 운영 대시보드"**를 구성해 보겠습니다.

- A. 핵심 KPI 스키마 (Redis/State Store 저장용)

```json
{
  "state": "SP",
  "current_outlier_count": 9461,
  "avg_prep_delay_hrs": 231.7,
  "system_impact_potential": "HIGH",
  "recommendation": "안전 재고(Safety Stock)를 현재 대비 15% 상향 조정하여 출고 지연 리스크 방어 필요"
}
```

- B. API 명세 제안

- Endpoint: GET /api/v1/logistics/bottleneck
- Description: 현재 출고 지연이 심한 지역과 해당 지역 셀러들의 재고 상태를 조인하여 알림 대상 추출.
- Action: 지연 시간이 100시간을 초과하는 셀러에게 "재고 보충 경고" 자동 발송.

4. 정리: 프로젝트의 "결정적 증거"

> "데이터 분석 결과, 지연 주문의 50% 이상이 운송이 아닌 **셀러의 출고 준비 단계(Seller Prep)**에서 발생함을 확인했다.
> 이에 따라 OMS 내에 이벤트 기반 재고 관리 시스템을 설계하여, 재고 부족으로 인한 출고 대기 시간을 원천적으로 차단함으로써 전체 배송 리드타임을 최대 40% 이상 개선할 수 있는 기술적 토대를 마련했다."

# 12. 방향성

재고 관리 말고 고도화를 할 수 있는 다른 방법은?

- 네트워크 중심: "가장 가까운 곳에서 보내게 로직을 짜자" (Smart Routing)
