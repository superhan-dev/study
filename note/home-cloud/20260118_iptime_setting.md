# 홈클라우드 iptime setting

iptime 공유기를 사용하는 상황에서 홈클라우드로 활용하기 위해 진행한 상황들을 정리한다.

# 1. 내부 접속 성공 (맥미니 ↔ 리눅스)

가장 먼저 같은 집 안(공유기 안)에서 두 기기가 대화할 수 있는 환경을 만들었다.

- 리눅스 설정: openssh-server를 설치하고 SSH 서비스를 활성화
- IP 확인: 리눅스의 내부 주소가 192.168.0.7임을 확인.
- 접속 테스트: 맥미니 터미널에서 ssh shhan@192.168.0.7로 첫 접속에 성공했고, 이 과정에서 서버의 신분증(Fingerprint)을 승인했다.

# 2. 외부 접속 준비 (ipTIME 설정)

집 밖에서도 접속할 수 있도록 설정했다. ipTIME으로 접근하기 위해 192.168.0.1로 접근한뒤 계정을 입력하고 `Advanced setup`으로 들어가면 포트포워딩을 할 수 있게 된다.

- 포트포워딩: 포트포워딩 룰을 만들어서 외부에서 20022번 포트로 신호가 오면, 내부 리눅스의 22번(SSH) 포트로 보내도록 설정.

- 공인 IP 확인: curl ifconfig.me 명령어를 통해 외부에서 우리 집을 찾아올 수 있는 진짜 주소(Public IP)를 확인.

- 도메인(DDNS): IP가 바뀌어도 주소를 유지할 수 있도록 id.iptime.org 형태의 도메인 사용법을 확인.

# 3. 보안 강화

- 이중 방화벽: ipTIME 방화벽 외에도 리눅스 자체 방화벽(UFW)을 켜서 22번 포트만 열고 나머지는 잠갔습니다.

- Fail2Ban: 외부에서 누군가 비밀번호를 5번 이상 틀리면 해당 IP를 자동으로 차단하도록 설정.

- 화이트리스트: 내 맥미니 IP(ignoreip)를 등록해 본인이 실수로 차단되는 것을 방지.

- 로그 확인: /var/log/auth.log를 통해 누가 접속했는지, 공격 시도가 있는지 확인하는 법을 확인.

# 4. DDNS

문서에서 가능한 공인IP를 노출시키지 않기 위해 DDNS를 설정하여 외부에서 붙을때 도메인을 사용하도록 설정한다.

ipTIME 설정에서 `Advanced setup` > `utility` > `DDNS` 로 접근하면 도메인을 설정하는 방법이 나온다.

## 4.1. 도메인 설정

ipTIME 에서 기본적으로 제공하는 `*.iptime.org` 의 서브도메인으로 아이디를 등록하면 다음과 같이 설정이 된다. `superhan.iptime.org` 이와 같이 설정이 정상적으로 된다면 도메인으로 접근할 수 있게 된다.

## 4.2. DDNS 접근 방법

```bash
ssh -p 20022 shhan@superhan.iptime.org
# or
ssh -p 20022 shhan@아까*확인한*공인IP
```

## 4.3. db 접근

이제 도메인도 설정되었으니 DB도 도메인으로 붙어본다.

한 가지 문제가 있었다. postgresql은 5432를 기본 포트로 사용하는데 외부에서 붙기 위해 포트포워딩을 해주어야 했다.

이때 5432를 그대로 열면 보안상 좋지 않으므로 55432와 같은 포트를 열어주는게 좋다.
